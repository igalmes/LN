<h1 class="mb-4">Lista de Empleados</h1>

<style>
  .empleados-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
  }

  .empleado-card {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    padding: 20px;
    width: 220px;
  }

  .acciones {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
  }
</style>

<!-- CONTADOR -->
<p class="text-muted mb-3">
  Total visibles: <strong id="contador"><%= empleados.length %></strong>
</p>

<!-- FILTROS -->
<div class="row mb-3">
  <div class="col-md-3">
    <input id="filtroNombre" class="form-control" placeholder="Nombre / Apellido">
  </div>

  <div class="col-md-3">
    <input id="filtroCuit" class="form-control" placeholder="CUIT">
  </div>

  <div class="col-md-6 d-flex gap-2">
    <button id="ordenarAZ" class="btn btn-outline-secondary">
      Ordenar Aâ€“Z
    </button>

    <button id="exportExcel" class="btn btn-success">
      Exportar Excel
    </button>

    <button id="exportPDF" class="btn btn-danger">
      Exportar PDF
    </button>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-4">
    <div class="card text-bg-primary">
      <div class="card-body text-center">
        <h5>Total empleados</h5>
        <h2><%= totalEmpleados %></h2>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card text-bg-success">
      <div class="card-body text-center">
        <h5>Con unidad</h5>
        <h2><%= conUnidad %></h2>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card text-bg-secondary">
      <div class="card-body text-center">
        <h5>Sin unidad</h5>
        <h2><%= sinUnidad %></h2>
      </div>
    </div>
  </div>
</div>

<div class="d-flex justify-content-between mb-3">
  <a href="/empleado/nuevo" class="btn btn-primary">
    âž• Agregar empleado
  </a>

  <a href="/empleado/export/pdf/download" class="btn btn-danger">
    ðŸ“„ Descargar PDF
  </a>
</div>


<!-- CARDS -->
<div class="empleados-container" id="contenedorEmpleados">
  <% empleados.forEach(emp => { %>
    <div class="empleado-card empleado"
         data-nombre="<%= (emp.nombre + ' ' + emp.apellido).toLowerCase() %>"
         data-cuit="<%= emp.cuit %>">

      <h3><%= emp.nombre %> <%= emp.apellido %></h3>
      <p><strong>DNI:</strong> <%= emp.dni %></p>
      <p><strong>CUIT:</strong> <%= emp.cuit %></p>

<div class="acciones">
  <a href="/empleado/<%= emp.id %>" class="btn btn-outline-primary btn-sm">Ver</a>
  <a href="/empleado/<%= emp.id %>/edit" class="btn btn-outline-warning btn-sm">Editar</a>
  <a href="/empleado/<%= emp.id %>/asignar-unidad" class="btn btn-outline-success btn-sm">Asignar Unidad</a>
  <form action="/empleado/<%= emp.id %>?_method=DELETE"
        method="POST"
        onsubmit="return confirm('Â¿Eliminar empleado?');">
    <button class="btn btn-outline-danger btn-sm">Eliminar</button>
  </form>
</div>

    </div>
  <% }) %>
</div>

<!-- LIBRERÃAS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  const filtroNombre = document.getElementById('filtroNombre');
  const filtroCuit = document.getElementById('filtroCuit');
  const cards = [...document.querySelectorAll('.empleado')];
  const contenedor = document.getElementById('contenedorEmpleados');
  const contador = document.getElementById('contador');
  let ordenAsc = true;

  function filtrar() {
    let visibles = 0;

    cards.forEach(card => {
      const nombre = card.dataset.nombre;
      const cuit = card.dataset.cuit;

      if (
        nombre.includes(filtroNombre.value.toLowerCase()) &&
        cuit.includes(filtroCuit.value)
      ) {
        card.style.display = 'block';
        visibles++;
      } else {
        card.style.display = 'none';
      }
    });

    contador.textContent = visibles;
  }

  filtroNombre.addEventListener('input', filtrar);
  filtroCuit.addEventListener('input', filtrar);

  // ORDENAR A-Z / Z-A
  document.getElementById('ordenarAZ').addEventListener('click', () => {
    cards.sort((a, b) => {
      return ordenAsc
        ? a.dataset.nombre.localeCompare(b.dataset.nombre)
        : b.dataset.nombre.localeCompare(a.dataset.nombre);
    });

    ordenAsc = !ordenAsc;
    contenedor.innerHTML = '';
    cards.forEach(card => contenedor.appendChild(card));
  });

  // EXPORTAR EXCEL
  document.getElementById('exportExcel').addEventListener('click', () => {
    const data = cards
      .filter(c => c.style.display !== 'none')
      .map(c => ({
        Nombre: c.querySelector('h3').innerText,
        DNI: c.children[1].innerText.replace('DNI: ', ''),
        CUIT: c.children[2].innerText.replace('CUIT: ', '')
      }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Empleados');
    XLSX.writeFile(wb, 'empleados.xlsx');
  });

  // EXPORTAR PDF
  document.getElementById('exportPDF').addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 10;

    doc.text('Listado de Empleados', 10, y);
    y += 10;

    cards
      .filter(c => c.style.display !== 'none')
      .forEach(c => {
        doc.text(c.querySelector('h3').innerText, 10, y);
        y += 7;
        if (y > 280) {
          doc.addPage();
          y = 10;
        }
      });

    doc.save('empleados.pdf');
  });
</script>
